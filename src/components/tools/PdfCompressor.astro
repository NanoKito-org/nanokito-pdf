---
import {
  Upload,
  FileText,
  Download,
  Trash2,
  Settings,
  AlertTriangle,
  CheckCircle,
  Loader2,
  Minimize2,
  Sparkles,
  CloudUpload,
  FileDown,
  Archive,
  Lock,
} from "lucide-react";

interface Props {
  labels?: {
    uploadTitle?: string;
    uploadDesc?: string;
    dropTitle?: string;
    processing?: string;
    download?: string;
    downloadAll?: string;
    settings?: string;
    quality?: string;
    grayscale?: string;
    grayscaleDesc?: string;
    warningTitle?: string;
    warningDesc?: string;
    qualityScreen?: string;
    qualityEbook?: string;
    qualityPrinter?: string;
    statusOptimizing?: string;
    statusProcessingPage?: string;
    statusError?: string;
    zipping?: string;
    footer?: string;
    trustBadge?: string;
  };
}

const {
  labels = {
    uploadTitle: "Compress PDF Files",
    uploadDesc: "Drag & drop PDF files here, or click to select",
    dropTitle: "Drop to Add",
    processing: "Processing...",
    download: "Download",
    downloadAll: "Download All ZIP",
    settings: "Compression Settings",
    quality: "Compression Level",
    grayscale: "Grayscale (B&W)",
    grayscaleDesc: "Converts to black & white for maximum reduction",

    qualityScreen: "Smallest size, low res (72 dpi)",
    qualityEbook: "Best balance of size & quality (150 dpi)",
    qualityPrinter: "High quality for printing (300 dpi)",
    statusOptimizing: "Optimizing PDF structure... This may take a moment.",
    statusProcessingPage: "Processing page {current} of {total}...",
    statusError: "Error processing file. Engine may not be loaded.",
    zipping: "Zipping...",
    footer: "",
    trustBadge: "Private & Secure: Works offline. No data leaves your device.",
  },
} = Astro.props;
---

<div
  class="w-full max-w-5xl mx-auto"
  id="pdf-compressor-app"
  data-labels={JSON.stringify(labels)}
>
  <!-- Main Container with Glass Effect -->
  <div class="pdf-compressor-container relative">
    <!-- Animated Background Gradient -->
    <div class="absolute inset-0 -z-10 overflow-hidden rounded-3xl">
      <div
        class="absolute inset-0 bg-gradient-to-br from-amber-500/5 via-orange-500/5 to-red-500/5 dark:from-amber-500/10 dark:via-orange-500/10 dark:to-red-500/10"
      >
      </div>
      <div class="gradient-orb gradient-orb-1"></div>
      <div class="gradient-orb gradient-orb-2"></div>
      <div class="gradient-orb gradient-orb-3"></div>
    </div>

    <!-- Glass Panel -->
    <div
      class="relative backdrop-blur-xl bg-white/60 dark:bg-slate-900/60 rounded-3xl border border-white/20 dark:border-slate-700/50 shadow-2xl shadow-amber-500/5 dark:shadow-amber-500/10 p-3 sm:p-6 md:p-8 overflow-hidden"
    >
      <!-- Decorative Corner Elements -->
      <div
        class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-amber-400/20 to-transparent rounded-bl-full pointer-events-none"
      >
      </div>
      <div
        class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-orange-400/20 to-transparent rounded-tr-full pointer-events-none"
      >
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- Left Column: Upload Zone -->
        <div class="lg:col-span-2">
          <!-- Upload Zone with Premium Design -->
          <div
            id="pdf-drop-zone"
            class="upload-zone relative group cursor-pointer h-full min-h-[320px] rounded-2xl transition-all duration-500"
          >
            <!-- Animated Border -->
            <div
              class="absolute inset-0 rounded-2xl bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 p-[2px] opacity-0 group-hover:opacity-100 transition-opacity duration-500"
            >
              <div
                class="absolute inset-[2px] rounded-[14px] bg-white dark:bg-slate-900"
              >
              </div>
            </div>

            <!-- Default Border -->
            <div
              class="absolute inset-0 rounded-2xl border-2 border-dashed border-slate-300/80 dark:border-slate-700/80 group-hover:border-transparent transition-all duration-500"
            >
            </div>

            <!-- Content Container -->
            <div
              class="relative h-full flex flex-col items-center justify-center text-center p-4 sm:p-8 z-10"
            >
              <!-- Floating Particles -->
              <div
                class="particles-container absolute inset-0 overflow-hidden rounded-2xl pointer-events-none"
              >
                <div class="particle particle-1"></div>
                <div class="particle particle-2"></div>
                <div class="particle particle-3"></div>
                <div class="particle particle-4"></div>
                <div class="particle particle-5"></div>
              </div>

              <!-- Icon with Glow -->
              <div class="relative mb-6">
                <div
                  class="absolute inset-0 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl blur-xl opacity-0 group-hover:opacity-40 transition-opacity duration-500 scale-150"
                >
                </div>
                <div
                  class="relative p-5 rounded-2xl bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 border border-amber-200/50 dark:border-amber-600/30 group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 shadow-lg shadow-amber-500/10"
                >
                  <CloudUpload
                    className="w-10 h-10 text-amber-600 dark:text-amber-400 group-hover:animate-bounce"
                  />
                </div>
              </div>

              <input
                type="file"
                id="pdf-input"
                accept="application/pdf"
                multiple
                class="hidden"
              />

              <h3
                class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-white dark:to-slate-300 bg-clip-text text-transparent mb-2 group-hover:from-amber-600 group-hover:to-orange-600 dark:group-hover:from-amber-400 dark:group-hover:to-orange-400 transition-all duration-500"
              >
                {labels.uploadTitle}
              </h3>

              <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs">
                {labels.uploadDesc}
              </p>

              <!-- Supported Format Badge -->
              <div
                class="mt-6 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100/80 dark:bg-slate-800/80 border border-slate-200/50 dark:border-slate-700/50"
              >
                <FileText className="w-4 h-4 text-red-500" />
                <span
                  class="text-xs font-medium text-slate-600 dark:text-slate-300"
                  >PDF Files Only</span
                >
              </div>
              <!-- Trust Badge -->
              <div
                class="mt-8 flex items-center justify-center gap-2 text-xs text-slate-500 dark:text-slate-400 bg-slate-100/50 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
              >
                <Lock className="w-3 h-3" />
                <span>{labels.trustBadge}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: File List -->
        <div class="lg:col-span-3">
          <div id="file-list" class="space-y-4 min-h-[320px]">
            <!-- Empty State with Premium Design -->
            <div
              id="empty-state"
              class="h-full min-h-[320px] flex flex-col items-center justify-center text-center p-8 rounded-2xl bg-gradient-to-br from-slate-50/50 to-slate-100/50 dark:from-slate-800/30 dark:to-slate-700/30 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div class="relative mb-6">
                <div
                  class="absolute inset-0 bg-slate-300 dark:bg-slate-600 rounded-full blur-2xl opacity-20 scale-150"
                >
                </div>
                <div
                  class="relative p-6 rounded-2xl bg-white/80 dark:bg-slate-800/80 border border-slate-200/50 dark:border-slate-700/50 shadow-lg"
                >
                  <Minimize2
                    className="w-12 h-12 text-slate-300 dark:text-slate-600"
                  />
                </div>
              </div>
              <p
                class="text-lg font-semibold text-slate-400 dark:text-slate-500 mb-2"
              >
                No files in queue
              </p>
              <p class="text-sm text-slate-400/70 dark:text-slate-500/70">
                Upload PDF files to start compressing
              </p>
            </div>
          </div>

          <!-- Action Bar (Appears when files exist) -->
          <div
            id="action-bar"
            class="hidden mt-6 pt-6 border-t border-slate-200/50 dark:border-slate-700/50"
          >
            <div class="flex items-center justify-between gap-4">
              <div
                class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400"
              >
                <Archive className="w-4 h-4" />
                <span>Multiple files ready</span>
              </div>
              <button
                id="download-all-btn"
                class="relative group/btn inline-flex items-center gap-3 px-6 py-3 rounded-xl font-bold text-white overflow-hidden transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-amber-500/25 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
              >
                <!-- Button Gradient Background -->
                <div
                  class="absolute inset-0 bg-gradient-to-r from-amber-500 via-orange-500 to-red-500"
                >
                </div>
                <div
                  class="absolute inset-0 bg-gradient-to-r from-amber-600 via-orange-600 to-red-600 opacity-0 group-hover/btn:opacity-100 transition-opacity duration-300"
                >
                </div>

                <!-- Button Content -->
                <span class="relative flex items-center gap-2">
                  <FileDown className="w-5 h-5" />
                  {labels.downloadAll}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Premium File Item Template -->
<template id="file-item-template">
  <div
    class="file-item group/card relative rounded-xl overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-xl animate-slide-in"
  >
    <!-- Card Background with Gradient Border on Hover -->
    <div
      class="absolute inset-0 bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 opacity-0 group-hover/card:opacity-100 transition-opacity duration-300 rounded-xl"
    >
    </div>

    <!-- Card Inner -->
    <div
      class="relative m-[1px] bg-white dark:bg-slate-900 rounded-[11px] p-3 sm:p-5"
    >
      <div class="flex items-start gap-3 sm:gap-4">
        <!-- PDF Icon with Glow -->
        <div class="relative flex-shrink-0">
          <div
            class="absolute inset-0 bg-red-500 rounded-xl blur-lg opacity-20"
          >
          </div>
          <div
            class="relative p-2 sm:p-3 rounded-xl bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/30 dark:to-red-800/30 border border-red-200/50 dark:border-red-700/50"
          >
            <FileText
              className="w-5 h-5 sm:w-6 sm:h-6 text-red-500 dark:text-red-400"
            />
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <!-- Header Row -->
          <div
            class="flex items-start justify-between gap-2 sm:gap-4 mb-2 sm:mb-3"
          >
            <div class="min-w-0 flex-1">
              <h4
                class="font-bold text-slate-800 dark:text-slate-100 truncate text-sm sm:text-base filename"
              >
                filename.pdf
              </h4>
              <div
                class="flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm mt-0.5 sm:mt-1"
              >
                <span
                  class="original-size text-slate-500 dark:text-slate-400 font-mono"
                  >2.4 MB</span
                >
                <span class="arrow hidden text-amber-500">
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                  </svg>
                </span>
                <span
                  class="new-size hidden font-mono font-bold text-emerald-600 dark:text-emerald-400"
                  >1.1 MB</span
                >
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center gap-1">
              <button
                class="settings-btn p-2 rounded-lg text-slate-400 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-all duration-200"
                title="Compression Settings"
              >
                <Settings className="w-4 h-4" />
              </button>
              <button
                class="remove-btn p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200"
                title="Remove File"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          </div>

          <!-- Settings Panel -->
          <div
            class="settings-panel mb-3 sm:mb-4 p-3 sm:p-4 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100/50 dark:from-slate-800/50 dark:to-slate-700/30 border border-slate-200/50 dark:border-slate-700/50"
            onclick="event.stopPropagation()"
          >
            <label
              class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 block"
            >
              Quality Profile
            </label>
            <div
              class="grid grid-cols-1 min-[380px]:grid-cols-3 gap-1.5 sm:gap-2"
            >
              <label class="quality-option cursor-pointer">
                <input
                  type="radio"
                  name="quality"
                  value="screen"
                  class="peer sr-only"
                />
                <div
                  class="quality-btn text-center py-2 sm:py-2.5 px-1.5 sm:px-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 text-xs sm:text-sm font-semibold text-slate-600 dark:text-slate-300 peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:text-white transition-all duration-200 hover:border-amber-400"
                >
                  Screen
                </div>
              </label>
              <label class="quality-option cursor-pointer">
                <input
                  type="radio"
                  name="quality"
                  value="ebook"
                  class="peer sr-only"
                  checked
                />
                <div
                  class="quality-btn text-center py-2 sm:py-2.5 px-1.5 sm:px-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 text-xs sm:text-sm font-semibold text-slate-600 dark:text-slate-300 peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:text-white transition-all duration-200 hover:border-amber-400"
                >
                  eBook
                </div>
              </label>
              <label class="quality-option cursor-pointer">
                <input
                  type="radio"
                  name="quality"
                  value="printer"
                  class="peer sr-only"
                />
                <div
                  class="quality-btn text-center py-2 sm:py-2.5 px-1.5 sm:px-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 text-xs sm:text-sm font-semibold text-slate-600 dark:text-slate-300 peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:text-white transition-all duration-200 hover:border-amber-400"
                >
                  Printer
                </div>
              </label>
            </div>
            <p class="text-xs text-slate-400 text-center mt-3 quality-desc">
              {labels.qualityEbook}
            </p>
          </div>

          <!-- Progress Section -->
          <div class="progress-section">
            <div class="flex justify-between items-center text-sm mb-2">
              <span
                class="status-text font-medium text-amber-600 dark:text-amber-400 flex items-center gap-2"
              >
                <span
                  class="status-indicator w-2 h-2 rounded-full bg-amber-500 animate-pulse"
                ></span>
                Waiting...
              </span>
              <span class="percentage text-slate-500 font-mono font-bold"
              ></span>
            </div>
            <div
              class="relative h-3 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"
            >
              <!-- Progress Bar with Gradient -->
              <div
                class="progress-bar absolute inset-y-0 left-0 bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 transition-all duration-300 w-0 rounded-full"
              >
                <div
                  class="absolute inset-0 bg-gradient-to-r from-white/30 to-transparent"
                >
                </div>
              </div>
              <!-- Shimmer Effect -->
              <div
                class="progress-shimmer absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full"
              >
              </div>
            </div>
          </div>

          <!-- Success Actions -->
          <div
            class="success-actions hidden mt-3 sm:mt-4"
            onclick="event.stopPropagation()"
          >
            <div
              class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3"
            >
              <button
                class="download-btn flex-1 relative group/dl inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl font-bold text-white overflow-hidden transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-emerald-500/25"
              >
                <!-- Button Gradient Background -->
                <div
                  class="absolute inset-0 bg-gradient-to-r from-emerald-500 to-teal-500"
                >
                </div>
                <div
                  class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-teal-600 opacity-0 group-hover/dl:opacity-100 transition-opacity"
                >
                </div>
                <span class="relative flex items-center gap-2">
                  <Download className="w-4 h-4" />
                  {labels.download}
                </span>
              </button>
              <div
                class="savings-badge justify-center px-4 py-3 rounded-xl bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/30 dark:to-teal-900/30 border border-emerald-200/50 dark:border-emerald-700/50 text-emerald-600 dark:text-emerald-400 font-bold text-sm flex items-center gap-2"
              >
                <Sparkles className="w-4 h-4" />
                <span>-45%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Footer -->

<!-- Premium Styles -->
<style>
  /* Gradient Orbs Animation */
  .gradient-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(60px);
    opacity: 0.4;
    animation: float 10s ease-in-out infinite;
  }

  .gradient-orb-1 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #f59e0b, #f97316);
    top: -50px;
    right: -50px;
    animation-delay: 0s;
  }

  .gradient-orb-2 {
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, #f97316, #ef4444);
    bottom: -30px;
    left: -30px;
    animation-delay: -3s;
  }

  .gradient-orb-3 {
    width: 180px;
    height: 180px;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation-delay: -5s;
  }

  @keyframes float {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(30px, -30px) scale(1.1);
    }
    66% {
      transform: translate(-20px, 20px) scale(0.9);
    }
  }

  /* Floating Particles */
  .particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: linear-gradient(135deg, #f59e0b, #f97316);
    border-radius: 50%;
    opacity: 0;
    animation: particle-float 4s ease-in-out infinite;
  }

  .particle-1 {
    left: 20%;
    animation-delay: 0s;
  }
  .particle-2 {
    left: 40%;
    animation-delay: 0.5s;
  }
  .particle-3 {
    left: 60%;
    animation-delay: 1s;
  }
  .particle-4 {
    left: 80%;
    animation-delay: 1.5s;
  }
  .particle-5 {
    left: 50%;
    animation-delay: 2s;
  }

  .upload-zone:hover .particle {
    opacity: 0.6;
  }

  @keyframes particle-float {
    0% {
      transform: translateY(100px) scale(0);
      opacity: 0;
    }
    50% {
      opacity: 0.6;
    }
    100% {
      transform: translateY(-100px) scale(1);
      opacity: 0;
    }
  }

  /* Slide In Animation */
  @keyframes slide-in {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .animate-slide-in {
    animation: slide-in 0.4s ease-out forwards;
  }

  /* Progress Shimmer */
  .progress-bar.active + .progress-shimmer {
    animation: shimmer 1.5s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  /* Drop Zone Active State */
  .upload-zone.active {
    border-color: transparent !important;
  }

  .upload-zone.active > div:first-child {
    opacity: 1 !important;
  }

  /* Dark Mode Adjustments */
  :global(.dark) .gradient-orb {
    opacity: 0.25;
  }
</style>

<script>
  import JSZip from "jszip";
  import * as pdfjsLib from "pdfjs-dist";

  // Set worker source for pdf.js (needed for getDocument)
  // Set worker source for pdf.js (needed for getDocument)
  pdfjsLib.GlobalWorkerOptions.workerSrc = "/pdfjs/pdf.worker.min.mjs";

  // State
  interface FileQueueItem {
    id: string;
    file: File;
    status: "pending" | "processing" | "done" | "error";
    originalSize: number;
    compressedSize?: number;
    blob?: Blob;
    element: HTMLElement;
    quality: "screen" | "ebook" | "printer";
    totalPages?: number;
    currentProgress: number;
    progressInterval?: number;
  }

  const queue: FileQueueItem[] = [];
  const MAX_CONCURRENT = 1;
  let processingCount = 0;

  // DOM
  const dropZone = document.getElementById("pdf-drop-zone");
  const fileInput = document.getElementById("pdf-input") as HTMLInputElement;
  const fileList = document.getElementById("file-list");
  const emptyState = document.getElementById("empty-state");
  const template = document.getElementById(
    "file-item-template",
  ) as HTMLTemplateElement;
  const downloadAllBtn = document.getElementById(
    "download-all-btn",
  ) as HTMLButtonElement;
  const actionBar = document.getElementById("action-bar");

  // Get Labels
  const appContainer = document.getElementById("pdf-compressor-app");
  const labels = JSON.parse(appContainer?.dataset.labels || "{}");

  // --- Upload Logic ---
  dropZone?.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) =>
    handleFiles((e.target as HTMLInputElement).files),
  );

  dropZone?.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("active");
  });

  dropZone?.addEventListener("dragleave", () => {
    dropZone.classList.remove("active");
  });

  dropZone?.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("active");
    if (e.dataTransfer?.files) handleFiles(e.dataTransfer.files);
  });

  function handleFiles(files: FileList | null) {
    if (!files) return;

    emptyState?.classList.add("hidden");

    Array.from(files).forEach((file) => {
      if (file.type !== "application/pdf") return;

      const id = Math.random().toString(36).substr(2, 9);
      const itemElement = createQueueElement(file, id, "ebook"); // Default to ebook
      fileList?.appendChild(itemElement);

      const item: FileQueueItem = {
        id,
        file,
        status: "pending",
        originalSize: file.size,
        element: itemElement,

        quality: "ebook",
        currentProgress: 0,
      };

      queue.push(item);
      processQueue();
    });

    // Update Action Bar Visibility
    if (queue.length > 1) {
      actionBar?.classList.remove("hidden");
    } else {
      actionBar?.classList.add("hidden");
    }

    // Reset input
    fileInput.value = "";
  }

  function createQueueElement(
    file: File,
    id: string,
    quality: string,
  ): HTMLElement {
    const clone = template.content.cloneNode(true) as DocumentFragment;
    const el = clone.querySelector(".file-item") as HTMLElement;
    el.dataset.id = id;

    // Set Info
    el.querySelector(".filename")!.textContent = file.name;
    el.querySelector(".original-size")!.textContent = formatBytes(file.size);

    // Settings UI Logic
    const settingsBtn = el.querySelector(".settings-btn") as HTMLButtonElement;
    const settingsPanel = el.querySelector(".settings-panel") as HTMLElement;
    const qualityInputs = el.querySelectorAll('input[name="quality"]');
    const qualityDesc = el.querySelector(".quality-desc") as HTMLElement;

    // Toggle Panel Function
    const togglePanel = () => {
      settingsPanel.classList.toggle("hidden");
      settingsBtn.classList.toggle("text-amber-500");
    };

    // Card Click
    el.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (
        target.closest("button") ||
        target.closest("input") ||
        target.closest("label")
      )
        return;
      togglePanel();
    });

    // Button Click
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      togglePanel();
    });

    // Update Settings State & Re-compress
    const updateAndRecompress = () => {
      const item = queue.find((i) => i.id === id);
      if (!item) return;

      if (item.status === "done" || item.status === "error") {
        item.status = "pending";
        const progressSection = el.querySelector(
          ".progress-section",
        ) as HTMLElement;
        const successActions = el.querySelector(
          ".success-actions",
        ) as HTMLElement;

        progressSection.classList.remove("hidden");
        successActions.classList.add("hidden");
        successActions.classList.remove("flex");

        processQueue();
      }
    };

    qualityInputs.forEach((input) => {
      input.addEventListener("change", (e) => {
        const target = e.target as HTMLInputElement;
        if (target.checked) {
          const val = target.value;
          const item = queue.find((i) => i.id === id);
          if (item) {
            item.quality = val as any;

            // Update description
            if (val === "screen")
              qualityDesc.textContent = labels.qualityScreen;
            if (val === "ebook") qualityDesc.textContent = labels.qualityEbook;
            if (val === "printer")
              qualityDesc.textContent = labels.qualityPrinter;

            updateAndRecompress();
          }
        }
      });
      (input as HTMLInputElement).name = `quality-${id}`;
    });

    // Events
    el.querySelector(".remove-btn")!.addEventListener("click", (e) => {
      e.stopPropagation();
      removeItem(id);
    });

    return el;
  }

  async function processQueue() {
    if (processingCount >= MAX_CONCURRENT) return;

    const nextItem = queue.find((i) => i.status === "pending");
    if (!nextItem) return;

    processingCount++;
    nextItem.status = "processing";
    updateItemUI(nextItem);

    // Disable settings
    const settingsPanel = nextItem.element.querySelector(".settings-panel");
    if (settingsPanel) {
      const inputs = settingsPanel.querySelectorAll("input");
      inputs.forEach((i) => (i.disabled = true));
      settingsPanel.classList.add("opacity-50", "pointer-events-none");
    }

    try {
      const arrayBuffer = await nextItem.file.arrayBuffer();

      // Get Page Count using pdf.js
      try {
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) })
          .promise;
        nextItem.totalPages = pdf.numPages;
      } catch (err) {
        console.warn("Could not get page count:", err);
        nextItem.totalPages = 0;
      }

      // Start Fake Progress
      nextItem.currentProgress = 0;
      nextItem.progressInterval = window.setInterval(() => {
        if (nextItem.currentProgress < 99) {
          // Faster initial progress
          let increment = 1;
          if (nextItem.currentProgress < 70) {
            increment = 2; // Very fast start
          } else if (nextItem.currentProgress < 90) {
            increment = 0.5; // Slow down a bit
          } else {
            increment = 0.1; // Crawl at the end
          }

          nextItem.currentProgress = Math.min(
            99,
            nextItem.currentProgress + increment,
          );

          const progressBar = nextItem.element.querySelector(
            ".progress-bar",
          ) as HTMLElement;
          const percentage = nextItem.element.querySelector(
            ".percentage",
          ) as HTMLElement;

          progressBar.style.width = `${nextItem.currentProgress}%`;
          percentage.textContent = `${Math.round(nextItem.currentProgress)}%`;
        }
      }, 100); // Update every 100ms (faster updates)

      // Spawn One-Shot Worker
      const worker = new Worker("/workers/ghostscriptWorker.js");

      worker.onmessage = (e) => {
        const { id, type, success, blob, error, current } = e.data;
        if (id !== nextItem.id) return;

        if (type === "progress") {
          const total = nextItem.totalPages || 0;
          if (total > 0) {
            const realPercent = Math.round((current / total) * 100);
            // Always take the higher value (fake vs real)
            nextItem.currentProgress = Math.max(
              nextItem.currentProgress,
              realPercent,
            );

            const progressBar = nextItem.element.querySelector(
              ".progress-bar",
            ) as HTMLElement;
            const percentage = nextItem.element.querySelector(
              ".percentage",
            ) as HTMLElement;
            const statusText = nextItem.element.querySelector(
              ".status-text",
            ) as HTMLElement;

            progressBar.classList.remove("animate-pulse");
            progressBar.style.width = `${nextItem.currentProgress}%`;
            percentage.textContent = `${Math.round(nextItem.currentProgress)}%`;
            statusText.textContent = labels.statusProcessingPage
              .replace("{current}", current.toString())
              .replace("{total}", total.toString());
          } else {
            // Fallback if we failed to get page count
            const statusText = nextItem.element.querySelector(
              ".status-text",
            ) as HTMLElement;
            statusText.textContent = labels.statusProcessingPage
              .replace("{current}", current.toString())
              .replace(" of {total}", "");
          }
          return;
        }

        // Clear interval
        if (nextItem.progressInterval) clearInterval(nextItem.progressInterval);

        if (success && blob) {
          nextItem.blob = blob;
          nextItem.compressedSize = blob.size;
          nextItem.status = "done";
        } else {
          console.error("Compression failed:", error);
          nextItem.status = "error";
        }

        worker.terminate(); // Cleanup
        processingCount--;
        updateItemUI(nextItem);
        processQueue();
      };

      worker.onerror = (err) => {
        console.error("Worker error:", err);
        if (nextItem.progressInterval) clearInterval(nextItem.progressInterval);
        nextItem.status = "error";
        worker.terminate();
        processingCount--;
        updateItemUI(nextItem);
        processQueue();
      };

      // Send to worker
      worker.postMessage(
        {
          id: nextItem.id,
          fileArrayBuffer: arrayBuffer,
          quality: nextItem.quality,
        },
        [arrayBuffer],
      );
    } catch (e) {
      console.error(e);
      if (nextItem.progressInterval) clearInterval(nextItem.progressInterval);
      nextItem.status = "error";
      processingCount--;
      updateItemUI(nextItem);
      processQueue();
    }
  }

  function updateItemUI(item: FileQueueItem) {
    const el = item.element;
    const progressSection = el.querySelector(
      ".progress-section",
    ) as HTMLElement;
    const successActions = el.querySelector(".success-actions") as HTMLElement;
    const arrow = el.querySelector(".arrow") as HTMLElement;
    const newSize = el.querySelector(".new-size") as HTMLElement;
    const settingsPanel = el.querySelector(".settings-panel") as HTMLElement;
    const statusText = el.querySelector(".status-text") as HTMLElement;
    const progressBar = el.querySelector(".progress-bar") as HTMLElement;

    if (item.status === "processing") {
      statusText.innerHTML = `<span class="status-indicator w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>${labels.statusOptimizing}`;
      progressBar.classList.add("animate-pulse");
      progressBar.style.width = "0%"; // Start at 0
    } else if (item.status === "done" && item.blob) {
      progressSection.classList.add("hidden");
      successActions.classList.remove("hidden");
      successActions.classList.add("flex");

      // Re-enable settings
      if (settingsPanel) {
        const inputs = settingsPanel.querySelectorAll("input");
        inputs.forEach((i) => (i.disabled = false));
        settingsPanel.classList.remove("opacity-50", "pointer-events-none");
      }

      // Update Sizes
      arrow.classList.remove("hidden");
      newSize.classList.remove("hidden");
      newSize.textContent = formatBytes(item.compressedSize!);

      // Savings Badge - update the span inside
      const savedBytes = item.originalSize - item.compressedSize!;
      const savedPercent = Math.round((savedBytes / item.originalSize) * 100);
      const savingsBadge = el.querySelector(".savings-badge") as HTMLElement;
      const savingsSpan = savingsBadge.querySelector("span");

      if (savedBytes > 0) {
        if (savingsSpan) savingsSpan.textContent = `-${savedPercent}%`;
        else savingsBadge.textContent = `-${savedPercent}%`;
        savingsBadge.classList.remove(
          "from-red-50",
          "to-rose-50",
          "border-red-200/50",
          "dark:from-red-900/30",
          "dark:to-rose-900/30",
          "dark:border-red-700/50",
          "text-red-600",
          "dark:text-red-400",
        );
        savingsBadge.classList.add(
          "from-emerald-50",
          "to-teal-50",
          "border-emerald-200/50",
          "dark:from-emerald-900/30",
          "dark:to-teal-900/30",
          "dark:border-emerald-700/50",
          "text-emerald-600",
          "dark:text-emerald-400",
        );
      } else {
        if (savingsSpan)
          savingsSpan.textContent = `+${Math.abs(savedPercent)}%`;
        else savingsBadge.textContent = `+${Math.abs(savedPercent)}%`;
        savingsBadge.classList.remove(
          "from-emerald-50",
          "to-teal-50",
          "border-emerald-200/50",
          "dark:from-emerald-900/30",
          "dark:to-teal-900/30",
          "dark:border-emerald-700/50",
          "text-emerald-600",
          "dark:text-emerald-400",
        );
        savingsBadge.classList.add(
          "from-red-50",
          "to-rose-50",
          "border-red-200/50",
          "dark:from-red-900/30",
          "dark:to-rose-900/30",
          "dark:border-red-700/50",
          "text-red-600",
          "dark:text-red-400",
        );
      }

      // Setup Download
      const downloadBtn = el.querySelector(
        ".download-btn",
      ) as HTMLButtonElement;
      downloadBtn.onclick = (e) => {
        e.stopPropagation();
        const url = URL.createObjectURL(item.blob!);
        const a = document.createElement("a");
        const nameParts = item.file.name.split(".");
        nameParts.pop(); // remove extension
        a.href = url;
        a.download = `${nameParts.join(".")}-compressed.pdf`;
        a.click();
      };
    } else if (item.status === "error") {
      statusText.innerHTML = `<span class="status-indicator w-2 h-2 rounded-full bg-red-500"></span>${labels.statusError}`;
      progressBar.classList.remove("animate-pulse");
      progressBar.classList.add("bg-red-500");
      // Re-enable settings even on error to allow retry
      if (settingsPanel) {
        const inputs = settingsPanel.querySelectorAll("input");
        inputs.forEach((i) => (i.disabled = false));
        settingsPanel.classList.remove("opacity-50", "pointer-events-none");
      }
    }
  }

  function formatBytes(bytes: number) {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  function removeItem(id: string) {
    const idx = queue.findIndex((i) => i.id === id);
    if (idx === -1) return;

    queue[idx].element.remove();
    queue.splice(idx, 1);

    if (queue.length === 0) {
      emptyState?.classList.remove("hidden");
    }

    if (queue.length > 1) {
      actionBar?.classList.remove("hidden");
    } else {
      actionBar?.classList.add("hidden");
    }
  }

  // --- Download All ---
  downloadAllBtn.addEventListener("click", async () => {
    const doneItems = queue.filter((i) => i.status === "done" && i.blob);
    if (doneItems.length === 0) return;

    downloadAllBtn.disabled = true;
    downloadAllBtn.textContent = labels.zipping;

    const zip = new JSZip();
    doneItems.forEach((item) => {
      const nameParts = item.file.name.split(".");
      nameParts.pop();
      zip.file(`${nameParts.join(".")}-compressed.pdf`, item.blob!);
    });

    const content = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(content);
    const a = document.createElement("a");
    a.href = url;
    a.download = "compressed-pdfs.zip";
    a.click();

    downloadAllBtn.disabled = false;
    downloadAllBtn.textContent = labels.downloadAll;
  });
</script>
