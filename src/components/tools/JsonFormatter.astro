---
import {
  Copy,
  Trash2,
  Check,
  Minimize2,
  Maximize2,
  FileJson,
  AlertTriangle,
} from "lucide-react";

interface Props {
  labels?: {
    prettify: string;
    minify: string;
    clear: string;
    copy: string;
    valid: string;
    invalid: string;
    validating: string;
    input: string;
    output: string;
    syntaxError: string;
    placeholderInput: string;
    placeholderOutput: string;
    ready: string;
  };
}

const {
  labels = {
    prettify: "Prettify",
    minify: "Minify",
    clear: "Clear",
    copy: "Copy",
    valid: "Valid JSON",
    invalid: "Invalid JSON",
    validating: "Validating...",
    input: "INPUT",
    output: "OUTPUT",
    syntaxError: "Syntax Error",
    placeholderInput: "// Paste your JSON here...",
    placeholderOutput: "// Formatted output...",
    ready: "Ready",
  },
} = Astro.props;
---

<div
  class="json-editor-container bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-800 flex flex-col h-[600px] md:h-[700px]"
>
  {/* Toolbar */}
  <div
    class="flex flex-col sm:flex-row sm:items-center justify-between p-3 border-b border-slate-800 bg-slate-900 gap-3"
  >
    <div class="flex flex-wrap items-center gap-2">
      {/* Primary Action */}
      <button
        id="prettify-btn"
        class="flex items-center gap-2 px-4 py-2 rounded-md bg-yellow-400 hover:bg-yellow-500 active:bg-yellow-600 text-slate-900 font-bold transition-all active:scale-95 shadow-lg shadow-yellow-400/10 text-sm cursor-pointer"
      >
        <Maximize2 className="w-4 h-4" />
        {labels.prettify}
      </button>

      {/* Secondary Actions */}
      <button
        id="minify-btn"
        class="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700 hover:border-slate-600 active:bg-slate-600 active:border-slate-500 text-slate-300 hover:text-white transition-all text-sm font-medium cursor-pointer active:scale-95"
      >
        <Minimize2 className="w-4 h-4" />
        {labels.minify}
      </button>

      <button
        id="copy-btn"
        class="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700 hover:border-slate-600 active:bg-slate-600 active:border-slate-500 text-slate-300 hover:text-white transition-all text-sm font-medium group cursor-pointer active:scale-95"
      >
        <Copy
          className="w-4 h-4 default-icon group-hover:scale-110 transition-transform"
        />
        <Check className="w-4 h-4 success-icon hidden text-green-400" />
        {labels.copy}
      </button>

      <button
        id="clear-btn"
        class="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-red-500/10 active:bg-red-500/20 text-slate-400 hover:text-red-400 active:text-red-300 transition-all text-sm font-medium ml-2 cursor-pointer active:scale-90"
        title={labels.clear}
      >
        <Trash2 className="w-4 h-4" />
      </button>
    </div>

    {/* Status Indicator */}
    <div
      id="status-badge"
      class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs font-mono font-medium text-slate-400 transition-colors duration-300"
    >
      <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-500"></div>
      <span id="status-text">{labels.validating}</span>
    </div>
  </div>

  {/* Editor Area (Split View) */}
  <div class="flex-1 flex flex-col md:flex-row relative">
    {/* Left: Input */}
    <div class="flex-1 relative flex flex-col group min-h-[300px]">
      <div
        class="absolute top-0 right-0 px-2 py-1 bg-slate-800/50 text-[10px] text-slate-500 font-mono rounded-bl-lg z-10 pointer-events-none"
      >
        {labels.input}
      </div>
      <textarea
        id="json-input"
        class="w-full h-full bg-slate-950 text-slate-300 p-4 font-mono text-sm resize-none outline-none border-b md:border-b-0 md:border-r border-slate-800 focus:bg-slate-950/80 transition-colors custom-scrollbar"
        placeholder={labels.placeholderInput}
        spellcheck="false"></textarea>
    </div>

    {/* Right: Output */}
    <div class="flex-1 relative flex flex-col min-h-[300px]">
      <div
        class="absolute top-0 right-0 px-2 py-1 bg-slate-800/50 text-[10px] text-slate-500 font-mono rounded-bl-lg z-10 pointer-events-none"
      >
        {labels.output}
      </div>

      <textarea
        id="json-output"
        readonly
        class="w-full h-full bg-slate-950 text-slate-300 p-4 font-mono text-sm resize-none outline-none border-t md:border-t-0 border-slate-800 transition-colors custom-scrollbar"
        placeholder={labels.placeholderOutput}
        spellcheck="false"></textarea>

      {/* Error Overlay */}
      <div
        id="error-overlay"
        class="absolute bottom-4 left-4 right-4 bg-red-900/95 border border-red-500/50 text-white p-4 rounded-lg shadow-xl backdrop-blur-sm transform translate-y-4 opacity-0 pointer-events-none transition-all duration-300 flex items-start gap-3"
      >
        <AlertTriangle className="w-5 h-5 text-red-400 shrink-0 mt-0.5" />
        <div class="flex-1 min-w-0">
          <h4 class="font-bold text-sm text-red-100 mb-1">
            {labels.syntaxError}
          </h4>
          <p
            id="error-message"
            class="font-mono text-xs text-red-200/90 break-words"
          >
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom Scrollbar for "Code Editor" feel */
  .custom-scrollbar::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #0f172a; /* slate-900 */
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #334155; /* slate-700 */
    border: 2px solid #0f172a; /* slate-900 */
    border-radius: 5px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #475569; /* slate-600 */
  }
</style>

<script define:vars={{ labels }}>
  // Elements
  const input = document.getElementById("json-input");
  const output = document.getElementById("json-output");
  const statusBadge = document.getElementById("status-badge");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");
  const errorOverlay = document.getElementById("error-overlay");
  const errorMessage = document.getElementById("error-message");

  // Buttons
  const btnPrettify = document.getElementById("prettify-btn");
  const btnMinify = document.getElementById("minify-btn");
  const btnClear = document.getElementById("clear-btn");
  const btnCopy = document.getElementById("copy-btn");

  // State
  // Use labels passed from Astro frontmatter
  const LABELS = {
    valid: labels.valid,
    invalid: labels.invalid,
    empty: labels.ready,
  };

  function setStatus(state: "valid" | "invalid" | "empty") {
    if (!statusBadge || !statusDot || !statusText) return;

    // Reset classes
    statusBadge.className =
      "flex items-center gap-2 px-3 py-1.5 rounded-full border text-xs font-mono font-medium transition-colors duration-300";
    statusDot.className = "w-2 h-2 rounded-full";

    if (state === "valid") {
      statusBadge.classList.add(
        "bg-green-500/10",
        "border-green-500/20",
        "text-green-400",
      );
      statusDot.classList.add("bg-green-500");
      statusText.textContent = LABELS.valid;
    } else if (state === "invalid") {
      statusBadge.classList.add(
        "bg-red-500/10",
        "border-red-500/20",
        "text-red-400",
      );
      statusDot.classList.add("bg-red-500");
      statusText.textContent = LABELS.invalid;
    } else {
      statusBadge.classList.add(
        "bg-slate-800",
        "border-slate-700",
        "text-slate-400",
      );
      statusDot.classList.add("bg-slate-500");
      statusText.textContent = LABELS.empty;
    }
  }

  function showError(msg: string) {
    if (!errorOverlay || !errorMessage) return;
    errorMessage.textContent = msg;

    // Show overlay
    errorOverlay.classList.remove(
      "translate-y-4",
      "opacity-0",
      "pointer-events-none",
    );

    // Red border on output
    output.classList.add("border-l-4", "border-l-red-500", "bg-red-950/10"); // Visual cue on the editor itself
    // Note: Tailwind border utilities might conflict with the structural borders.
    // Let's use box-shadow inset for error state to avoid layout shift
    output.classList.add("shadow-[inset_0_0_0_2px_rgba(239,68,68,0.5)]");
  }

  function hideError() {
    if (!errorOverlay) return;

    // Hide overlay
    errorOverlay.classList.add(
      "translate-y-4",
      "opacity-0",
      "pointer-events-none",
    );

    // Remove red border
    output.classList.remove("border-l-4", "border-l-red-500", "bg-red-950/10");
    output.classList.remove("shadow-[inset_0_0_0_2px_rgba(239,68,68,0.5)]");
  }

  function processJSON(prettify = true) {
    const raw = input.value;

    if (!raw.trim()) {
      output.value = "";
      hideError();
      setStatus("empty");
      return;
    }

    try {
      const parsed = JSON.parse(raw);
      const formatted = prettify
        ? JSON.stringify(parsed, null, 2)
        : JSON.stringify(parsed);

      output.value = formatted;
      hideError();
      setStatus("valid");
    } catch (e) {
      // Keep the previous output or clear it?
      // VS Code usually keeps the old valid state or shows nothing.
      // Let's clear output to indicate "current input produces nothing valid"
      // Or maybe better: Don't update output if it was valid before?
      // The prompt says "If the user pastes bad JSON... Turn the Output... Red".
      // So we can just clear it and show error.
      output.value = "";
      showError((e as Error).message);
      setStatus("invalid");
    }
  }

  // Event Listeners
  if (input) {
    // Debounce input to avoid flashing on every keystroke?
    // For a local tool, instant is usually fine unless very large data.
    input.addEventListener("input", () => processJSON(true));

    btnPrettify?.addEventListener("click", () => processJSON(true));
    btnMinify?.addEventListener("click", () => processJSON(false));

    btnClear?.addEventListener("click", () => {
      input.value = "";
      output.value = "";
      hideError();
      setStatus("empty");
      input.focus();
    });

    btnCopy?.addEventListener("click", () => {
      if (!output.value) return;
      navigator.clipboard.writeText(output.value).then(() => {
        const btn = btnCopy;
        const def = btn?.querySelector(".default-icon");
        const suc = btn?.querySelector(".success-icon");

        def?.classList.add("hidden");
        suc?.classList.remove("hidden");
        btn?.classList.add("text-green-400");

        setTimeout(() => {
          def?.classList.remove("hidden");
          suc?.classList.add("hidden");
          btn?.classList.remove("text-green-400");
        }, 2000);
      });
    });

    // Initialize empty state
    setStatus("empty");
  }
</script>
