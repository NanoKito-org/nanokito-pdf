---
interface Props {
  labels?: {
    uploadTitle: string;
    uploadDesc: string;
    original: string;
    compressed: string;
    quality: string;
    download: string;
    loading: string;
  };
}

const {
  labels = {
    uploadTitle: "Drag & Drop or Click to Upload",
    uploadDesc: "JPG, PNG, WEBP. 100% Client-Side. No Server Uploads.",
    original: "Original",
    compressed: "Compressed Preview",
    quality: "Image Quality",
    download: "Download Compressed Image",
    loading: "Compressing...",
  },
} = Astro.props;
---

<div id="image-compressor" class="w-full">
  <!-- Upload Zone -->
  <div
    id="upload-zone"
    class="w-full h-80 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl bg-slate-50 dark:bg-slate-900/50 flex flex-col items-center justify-center cursor-pointer hover:bg-yellow-400/10 dark:hover:bg-yellow-400/5 hover:border-yellow-400 dark:hover:border-yellow-400 transition-all duration-300 group"
  >
    <div
      class="p-4 rounded-full bg-white dark:bg-slate-800 text-slate-400 group-hover:bg-yellow-400 group-hover:text-slate-900 transition-all duration-300 mb-4 ring-1 ring-slate-200 dark:ring-slate-700 group-hover:ring-yellow-500 scale-100 group-hover:scale-110 shadow-sm"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="40"
        height="40"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-upload"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" x2="12" y1="3" y2="15"></line>
      </svg>
    </div>
    <h3
      class="text-xl font-bold text-slate-700 dark:text-slate-200 group-hover:text-amber-600 dark:group-hover:text-yellow-400 transition-colors"
    >
      {labels.uploadTitle}
    </h3>
    <p
      class="text-slate-500 dark:text-slate-500 mt-2 text-sm max-w-xs text-center"
    >
      {labels.uploadDesc}
    </p>
    <input
      type="file"
      id="file-input"
      accept="image/png, image/jpeg, image/webp"
      class="hidden"
    />
  </div>

  <!-- Loading State (Initial) -->
  <div
    id="loading-state"
    class="hidden w-full py-20 flex-col items-center justify-center text-center animate-fade-up"
  >
    <div class="relative w-16 h-16 mb-6">
      <div
        class="absolute inset-0 border-4 border-slate-200 dark:border-slate-800 rounded-full"
      >
      </div>
      <div
        class="absolute inset-0 border-4 border-amber-500 dark:border-yellow-400 rounded-full border-t-transparent animate-spin"
      >
      </div>
    </div>
    <p class="text-amber-600 dark:text-yellow-400 font-mono animate-pulse">
      {labels.loading}
    </p>
  </div>

  <!-- Workspace (Hidden by default) -->
  <!-- Workspace (Hidden by default) -->
  <div id="workspace" class="hidden flex-col gap-8 animate-fade-up">
    <!-- Comparison Slider & Stats -->
    <div class="flex flex-col gap-4">
      <!-- Stats Header -->
      <div class="flex items-center justify-between px-2">
        <div class="flex flex-col">
          <span
            class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
            >{labels.original}</span
          >
          <span
            id="original-size"
            class="font-mono text-slate-700 dark:text-slate-200">0.00 MB</span
          >
        </div>
        <div
          id="savings-badge"
          class="hidden px-3 py-1 rounded-full bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 text-sm font-bold"
        >
          -0%
        </div>
        <div class="flex flex-col items-end">
          <span
            class="text-xs font-bold text-amber-600 dark:text-yellow-500 uppercase tracking-wider"
            >{labels.compressed}</span
          >
          <span
            id="compressed-size"
            class="font-mono text-amber-600 dark:text-yellow-400">0.00 MB</span
          >
        </div>
      </div>

      <!-- Desktop Comparison Viewer (Slider) -->
      <div
        class="hidden md:block relative w-full aspect-video rounded-2xl overflow-hidden bg-[url('/grid-pattern.svg')] bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-2xl select-none group"
      >
        <!-- Original Image (Background) -->
        <img
          id="preview-original"
          class="absolute inset-0 w-full h-full object-contain opacity-50 grayscale transition-all duration-300 group-hover:opacity-100 group-hover:grayscale-0"
        />

        <!-- Compressed Image (Foreground - Clipped) -->
        <div
          id="compare-overlay"
          class="absolute inset-0 w-full h-full border-r-2 border-amber-500 dark:border-yellow-400 bg-slate-50 dark:bg-slate-900"
          style="clip-path: inset(0 50% 0 0);"
        >
          <img
            id="preview-compressed"
            class="absolute inset-0 w-full h-full object-contain"
          />
        </div>

        <!-- Slider Handle (Visual) -->
        <div
          id="slider-handle"
          class="absolute top-0 bottom-0 left-1/2 w-1 bg-amber-500 dark:bg-yellow-400 cursor-ew-resize z-20 flex items-center justify-center -translate-x-1/2 hover:scale-110 transition-transform"
        >
          <div
            class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 shadow-lg border-2 border-amber-500 dark:border-yellow-400 flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-slate-600 dark:text-slate-200"
              ><path d="m9 18 6-6-6-6"></path></svg
            >
          </div>
        </div>

        <!-- Invisible Range Input (Interaction) -->
        <input
          type="range"
          id="compare-slider"
          min="0"
          max="100"
          value="50"
          class="absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-30"
        />

        <!-- Loading Overlay -->
        <div
          id="compression-loader"
          class="absolute inset-0 bg-white/60 dark:bg-slate-900/80 backdrop-blur-sm z-40 hidden items-center justify-center"
        >
          <div class="flex flex-col items-center gap-4">
            <div
              class="w-10 h-10 border-4 border-slate-200 dark:border-slate-700 border-t-amber-500 dark:border-t-yellow-400 rounded-full animate-spin"
            >
            </div>
            <span
              class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400"
              >Optimizing...</span
            >
          </div>
        </div>

        <!-- Zoom Toolbar (Desktop Only) -->
        <div
          class="absolute top-4 right-4 z-50 flex items-center gap-2 p-1.5 rounded-lg bg-black/60 backdrop-blur-md border border-white/10 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        >
          <!-- Pan Toggle -->
          <button
            id="pan-toggle"
            class="p-1.5 rounded-md text-slate-300 hover:text-white hover:bg-white/10 transition-colors"
            title="Toggle Pan Mode (Spacebar)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path><path
                d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path><path
                d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path
                d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"
              ></path></svg
            >
          </button>
          <div class="w-px h-4 bg-white/20 mx-0.5"></div>
          <!-- Zoom Out -->
          <button
            id="zoom-out-btn"
            class="p-1.5 rounded-md text-slate-300 hover:text-white hover:bg-white/10 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                x2="16.65"
                y1="21"
                y2="16.65"></line><line x1="8" x2="14" y1="11" y2="11"
              ></line></svg
            >
          </button>
          <!-- Zoom Value -->
          <span
            id="zoom-value"
            class="text-xs font-mono font-bold text-white min-w-[3ch] text-center"
            >100%</span
          >
          <!-- Zoom In -->
          <button
            id="zoom-in-btn"
            class="p-1.5 rounded-md text-slate-300 hover:text-white hover:bg-white/10 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                x2="16.65"
                y1="21"
                y2="16.65"></line><line x1="11" x2="11" y1="8" y2="14"
              ></line><line x1="8" x2="14" y1="11" y2="11"></line></svg
            >
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Comparison Viewer (Press & Hold) -->
    <div
      id="mobile-compare-container"
      class="md:hidden relative w-full aspect-square rounded-2xl overflow-hidden bg-[url('/grid-pattern.svg')] bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl select-none"
    >
      <!-- Mobile Image Display -->
      <img
        id="mobile-preview"
        class="w-full h-full object-contain pointer-events-none transition-transform duration-200"
      />

      <!-- Hidden Original for Preloading -->
      <img id="mobile-preload-original" class="hidden" />

      <!-- Mobile Badge Overlay -->
      <div
        class="absolute bottom-4 left-0 right-0 flex justify-center pointer-events-none z-10"
      >
        <div
          id="mobile-badge"
          class="px-4 py-2 rounded-full bg-black/60 backdrop-blur-md text-white border border-white/20 shadow-lg text-xs font-medium transition-all duration-200 text-center"
        >
          Pinch to Zoom • Press & Hold to Compare
        </div>
      </div>

      <!-- Mobile Loading Overlay -->
      <div
        id="mobile-loader"
        class="absolute inset-0 bg-white/60 dark:bg-slate-900/80 backdrop-blur-sm z-20 hidden items-center justify-center transition-opacity"
      >
        <div
          class="animate-spin w-8 h-8 border-4 border-amber-500 border-t-transparent rounded-full"
        >
        </div>
      </div>
    </div>

    <p
      class="hidden md:block text-center text-xs text-slate-400 dark:text-slate-500"
    >
      Drag slider to compare • <span class="text-amber-600 dark:text-yellow-400"
        >Original (Left)</span
      > vs <span class="text-amber-600 dark:text-yellow-400"
        >Compressed (Right)</span
      >
    </p>

    <p class="md:hidden text-center text-xs text-slate-400 dark:text-slate-500">
      Results shown are final. Zoom or Hold to verify.
    </p>
  </div>

  <!-- Controls Sticky Bar -->
  <div
    id="controls-section"
    class="hidden sticky bottom-4 z-50 p-4 rounded-xl bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border border-slate-200 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-black/50 flex flex-col gap-4"
  >
    <!-- PNG Hint & Options -->
    <div class="flex flex-col gap-2">
      <!-- Output Format Selection -->
      <div
        class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-800"
      >
        <span
          class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400"
          >Output Format</span
        >
        <div
          class="flex p-1 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700"
        >
          <button
            id="format-original"
            class="px-3 py-1 text-xs font-bold rounded-md bg-amber-100 dark:bg-yellow-400/20 text-amber-700 dark:text-yellow-400 shadow-sm transition-all"
            >Original</button
          >
          <button
            id="format-webp"
            class="px-3 py-1 text-xs font-bold rounded-md text-slate-500 dark:text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-all"
            >WebP</button
          >
        </div>
      </div>

      <!-- WebP Efficiency Badge (Hidden by default) -->
      <div
        id="webp-badge"
        class="hidden p-3 rounded bg-green-50 dark:bg-green-500/10 border border-green-100 dark:border-green-500/20 text-xs text-green-600 dark:text-green-300 flex items-start gap-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="shrink-0 mt-0.5"
          ><path d="M12 2v4"></path><path d="m16.2 7.8 2.9-2.9"></path><path
            d="M18 12h4"></path><path d="m16.2 16.2 2.9 2.9"></path><path
            d="M12 18v4"></path><path d="m7.8 16.2-2.9 2.9"></path><path
            d="M2 12h4"></path><path d="m7.8 7.8-2.9-2.9"></path><circle
            cx="12"
            cy="12"
            r="3"></circle></svg
        >
        <span
          ><strong>WebP Mode:</strong> Best for big files. Converts images to next-gen
          WebP format for maximum compression.</span
        >
      </div>
    </div>

    <div class="flex flex-col md:flex-row items-center gap-6">
      <div class="w-full md:w-1/2 flex flex-col gap-3">
        <!-- Manual Controls -->
        <div class="flex flex-col gap-2 transition-all duration-300">
          <!-- Quality Presets -->
          <div class="flex gap-2 mb-1">
            <button
              class="quality-preset px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-md border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-amber-100 dark:hover:bg-yellow-400/10 hover:text-amber-600 dark:hover:text-yellow-400 hover:border-amber-200 dark:hover:border-yellow-400/50 transition-all"
              data-quality="92">High</button
            >
            <button
              class="quality-preset px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-md border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-amber-100 dark:hover:bg-yellow-400/10 hover:text-amber-600 dark:hover:text-yellow-400 hover:border-amber-200 dark:hover:border-yellow-400/50 transition-all"
              data-quality="75">Balanced</button
            >
            <button
              class="quality-preset px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-md border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-amber-100 dark:hover:bg-yellow-400/10 hover:text-amber-600 dark:hover:text-yellow-400 hover:border-amber-200 dark:hover:border-yellow-400/50 transition-all"
              data-quality="50">Max</button
            >
          </div>

          <div
            class="flex justify-between text-xs font-medium text-slate-500 dark:text-slate-400"
          >
            <span>{labels.quality}</span>
            <span
              id="quality-value"
              class="text-amber-600 dark:text-yellow-400 font-bold">75%</span
            >
          </div>
          <input
            type="range"
            id="quality-slider"
            min="10"
            max="100"
            value="75"
            class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-lg appearance-none cursor-pointer accent-amber-500 dark:accent-yellow-400 hover:accent-amber-400 dark:hover:accent-yellow-300"
          />
        </div>
      </div>

      <div class="w-full md:w-1/2 flex gap-3">
        <button
          id="reset-btn"
          class="px-4 py-3 rounded-lg bg-red-50 hover:bg-red-100 dark:bg-red-500/10 dark:hover:bg-red-500/20 text-red-600 dark:text-red-500 font-medium transition-colors cursor-pointer flex items-center justify-center border border-red-100 dark:border-transparent"
          title="Reset"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-trash-2"
            ><path d="M3 6h18"></path><path
              d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path
              d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line
              x1="10"
              x2="10"
              y1="11"
              y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg
          >
        </button>
        <button
          id="download-btn"
          class="flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-lg bg-amber-400 hover:bg-amber-500 dark:bg-yellow-400 dark:hover:bg-yellow-500 active:bg-amber-600 dark:active:bg-yellow-600 text-slate-900 font-bold transition-all hover:-translate-y-0.5 shadow-lg shadow-amber-400/20 dark:shadow-yellow-400/20 active:scale-95 cursor-pointer"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
            ></path><polyline points="7 10 12 15 17 10"></polyline><line
              x1="12"
              x2="12"
              y1="15"
              y2="3"></line></svg
          >
          {labels.download}
        </button>
      </div>
    </div>
  </div>

  <script>
    import Compressor from "compressorjs";

    // State
    let originalFile: File | null = null;
    let compressedBlob: Blob | null = null;

    // Elements
    const uploadZone = document.getElementById("upload-zone");
    const fileInput = document.getElementById("file-input") as HTMLInputElement;
    const loadingState = document.getElementById("loading-state");
    const workspace = document.getElementById("workspace");
    const controlsSection = document.getElementById("controls-section");

    const previewOriginal = document.getElementById(
      "preview-original",
    ) as HTMLImageElement;
    const previewCompressed = document.getElementById(
      "preview-compressed",
    ) as HTMLImageElement;
    const compressionLoader = document.getElementById("compression-loader");

    // Mobile Elements
    const mobileContainer = document.getElementById("mobile-compare-container");
    const mobilePreview = document.getElementById(
      "mobile-preview",
    ) as HTMLImageElement;
    const mobilePreloadOriginal = document.getElementById(
      "mobile-preload-original",
    ) as HTMLImageElement;
    const mobileBadge = document.getElementById("mobile-badge");
    const mobileLoader = document.getElementById("mobile-loader");

    const originalSize = document.getElementById("original-size");
    const compressedSize = document.getElementById("compressed-size");
    const savingsBadge = document.getElementById("savings-badge");

    const qualitySlider = document.getElementById(
      "quality-slider",
    ) as HTMLInputElement;
    const qualityValue = document.getElementById("quality-value");
    const downloadBtn = document.getElementById("download-btn");
    const resetBtn = document.getElementById("reset-btn");
    const presetBtns = document.querySelectorAll(".quality-preset");

    // Format Controls
    const formatOriginalBtn = document.getElementById("format-original");
    const formatWebPBtn = document.getElementById("format-webp");
    const webpBadge = document.getElementById("webp-badge");

    let outputFormat = "original"; // 'original' | 'webp'

    // Zoom & Pan State
    let zoomLevel = 1;
    let panMode = false;
    let panOffset = { x: 0, y: 0 };
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };

    // Zoom Controls
    const zoomInBtn = document.getElementById("zoom-in-btn");
    const zoomOutBtn = document.getElementById("zoom-out-btn");
    const zoomValue = document.getElementById("zoom-value");
    const panToggle = document.getElementById("pan-toggle");
    const desktopContainer = document.querySelector(".hidden.md\\:block"); // Select the desktop container wrapper

    // Comparison logic
    const compareOverlay = document.getElementById("compare-overlay");
    const sliderHandle = document.getElementById("slider-handle");
    const compareSlider = document.getElementById(
      "compare-slider",
    ) as HTMLInputElement;

    // Format Bytes
    function formatBytes(bytes: number, decimals = 2) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i];
    }

    // Handle Logic
    async function handleFile(file: File) {
      if (!file || !file.type.startsWith("image/")) return;

      originalFile = file;

      // Smart Defaults based on file type
      if (file.type === "image/png") {
        outputFormat = "webp";
      } else {
        outputFormat = "original";
      }
      updateFormatUI();

      // UI Update: Show Loading
      uploadZone?.classList.add("hidden");
      workspace?.classList.add("hidden");
      loadingState?.classList.remove("hidden");
      loadingState?.classList.add("flex");

      // Show Controls
      controlsSection?.classList.remove("hidden");
      controlsSection?.classList.add("flex");

      // Display Original
      const reader = new FileReader();
      reader.onload = (e) => {
        if (previewOriginal && e.target) {
          // @ts-ignore
          previewOriginal.src = e.target.result as string;
          // Also set compressed preview initially to avoid empty flash
          // @ts-ignore
          if (previewCompressed)
            previewCompressed.src = e.target.result as string;

          if (mobilePreview) mobilePreview.src = e.target.result as string;
          if (mobilePreloadOriginal)
            mobilePreloadOriginal.src = e.target.result as string;

          // Reset Zoom/Pan on new file
          zoomLevel = 1;
          panOffset = { x: 0, y: 0 };
          updateTransform();
          updateZoomUI();
        }
      };
      reader.readAsDataURL(file);
      if (originalSize) originalSize.textContent = formatBytes(file.size);

      // Initial Compression
      await compressImage();

      // UI Update: Show Workspace
      loadingState?.classList.remove("flex");
      loadingState?.classList.add("hidden");
      workspace?.classList.remove("hidden");
      workspace?.classList.add("flex");
    }

    async function compressImage() {
      if (!originalFile) return;

      const file = originalFile; // TS fix

      // Show Loader
      if (compressionLoader) {
        compressionLoader.classList.remove("hidden");
        compressionLoader.classList.add("flex");
      }
      if (mobileLoader) {
        mobileLoader.classList.remove("hidden");
        mobileLoader.classList.add("flex");
      }

      const qualityVal = parseInt(qualitySlider.value) / 100;

      if (qualityValue)
        qualityValue.textContent = `${Math.round(qualityVal * 100)}%`;

      try {
        // Yield to UI
        await new Promise((resolve) => setTimeout(resolve, 50));

        const blob = await new Promise<Blob>((resolve, reject) => {
          new Compressor(file, {
            quality: qualityVal,
            maxWidth: undefined, // NO RESIZING explicitly
            maxHeight: undefined,
            minWidth: 0,
            width: undefined,
            height: undefined,
            mimeType: outputFormat === "webp" ? "image/webp" : "auto", // Use selected format
            strict: true, // Strip metadata
            checkOrientation: true,
            success(result) {
              resolve(result);
            },
            error(err) {
              reject(err);
            },
          });
        });

        compressedBlob = blob;

        // Update Preview
        if (previewCompressed) {
          previewCompressed.src = URL.createObjectURL(compressedBlob);
        }

        // Update Mobile Preview
        if (mobilePreview) {
          mobilePreview.src = URL.createObjectURL(compressedBlob);
        }

        // Update Stats
        if (compressedSize)
          compressedSize.textContent = formatBytes(compressedBlob.size);

        // Savings
        if (savingsBadge && originalFile.size > 0) {
          const saved = originalFile.size - compressedBlob.size;
          const percent = (saved / originalFile.size) * 100;

          savingsBadge.classList.remove("hidden");

          if (percent > 0) {
            savingsBadge.textContent = `-${Math.round(percent)}%`;
            savingsBadge.className =
              "px-3 py-1 rounded-full bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 text-sm font-bold";
          } else {
            savingsBadge.textContent = `+${Math.abs(Math.round(percent))}%`;
            savingsBadge.className =
              "px-3 py-1 rounded-full bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 text-sm font-bold";
          }
        }
      } catch (error) {
        console.error(error);
      } finally {
        // Hide Loader
        if (compressionLoader) {
          compressionLoader.classList.remove("flex");
          compressionLoader.classList.add("hidden");
        }
        if (mobileLoader) {
          mobileLoader.classList.remove("flex");
          mobileLoader.classList.add("hidden");
        }
      }
    }

    // --- Event Listeners ---

    // Mobile Interaction logic
    let touchStartDist = 0;
    let touchStartZoom = 1;

    const handleTouchStart = (e: TouchEvent) => {
      // Pinch
      if (e.touches.length === 2) {
        touchStartDist = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY,
        );
        touchStartZoom = zoomLevel;
        return;
      }

      // Single Touch - Press & Hold OR Pan
      if (e.touches.length === 1) {
        if (zoomLevel > 1) {
          // Prepare for potential Pan
          // @ts-ignore
          dragStart = {
            x: e.touches[0].clientX - panOffset.x,
            y: e.touches[0].clientY - panOffset.y,
          };
        }

        // Start Press & Hold logic (Show Original)
        if (mobilePreview && mobilePreloadOriginal && mobileBadge) {
          mobilePreview.src = mobilePreloadOriginal.src;
          mobileBadge.textContent = "Original";
          mobileBadge.className =
            "px-4 py-2 rounded-full bg-amber-500 text-white border border-amber-400 shadow-lg text-sm font-bold transition-all duration-200 scale-105";
        }
      }
    };

    const handleTouchMove = (e: TouchEvent) => {
      // Pinch
      if (e.touches.length === 2) {
        e.preventDefault(); // Device zoom prevent
        const dist = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY,
        );
        const ratio = dist / touchStartDist;
        zoomLevel = Math.min(4, Math.max(1, touchStartZoom * ratio));
        // Center pinch? For now just simple zoom
        updateTransform();
        return;
      }

      // Pan
      if (e.touches.length === 1 && zoomLevel > 1) {
        e.preventDefault(); // Prevent scroll if zoomed
        panOffset = {
          // @ts-ignore
          x: e.touches[0].clientX - dragStart.x,
          // @ts-ignore
          y: e.touches[0].clientY - dragStart.y,
        };
        updateTransform();
      }
    };

    const handleTouchEnd = (e: TouchEvent) => {
      // If fingers lifted, revert "Press & Hold"
      if (e.touches.length === 0) {
        if (mobilePreview && compressedBlob && mobileBadge) {
          mobilePreview.src = URL.createObjectURL(compressedBlob);
          mobileBadge.textContent = "Pinch to Zoom • Press & Hold to Compare";
          mobileBadge.className =
            "px-4 py-2 rounded-full bg-black/60 backdrop-blur-md text-white border border-white/20 shadow-lg text-xs font-medium transition-all duration-200 text-center";
        }
      }
    };

    // Add context menu prevention for the mobile container
    mobileContainer?.addEventListener("contextmenu", (e) => e.preventDefault());

    mobileContainer?.addEventListener(
      "touchstart",
      handleTouchStart as EventListener,
      { passive: false },
    );
    mobileContainer?.addEventListener(
      "touchmove",
      handleTouchMove as EventListener,
      { passive: false },
    );
    mobileContainer?.addEventListener(
      "touchend",
      handleTouchEnd as EventListener,
    );
    mobileContainer?.addEventListener(
      "mousedown",
      handleTouchStart as EventListener,
    ); // Fallback
    mobileContainer?.addEventListener(
      "mouseup",
      handleTouchEnd as EventListener,
    );
    mobileContainer?.addEventListener(
      "mouseleave",
      handleTouchEnd as EventListener,
    ); // Safety fallback

    // Comparison Slider
    compareSlider?.addEventListener("input", (e) => {
      // @ts-ignore
      const val = e.target.value;
      if (compareOverlay)
        compareOverlay.style.clipPath = `inset(0 ${100 - val}% 0 0)`;
      if (sliderHandle) sliderHandle.style.left = `${val}%`;
    });

    // Upload Zone
    uploadZone?.addEventListener("click", () => fileInput?.click());

    uploadZone?.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadZone.classList.add("bg-yellow-400/10", "border-yellow-400");
    });

    uploadZone?.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("bg-yellow-400/10", "border-yellow-400");
    });

    uploadZone?.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("bg-yellow-400/10", "border-yellow-400");
      if (e.dataTransfer?.files?.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput?.addEventListener("change", (e) => {
      // @ts-ignore
      if ((e.target as HTMLInputElement).files?.length) {
        // @ts-ignore
        handleFile((e.target as HTMLInputElement).files[0]);
      }
    });

    // Controls
    let timeout: any;
    qualitySlider?.addEventListener("input", () => {
      const val = qualitySlider.value;
      if (qualityValue) qualityValue.textContent = `${val}%`;

      // Show loader immediately on input
      if (compressionLoader) {
        compressionLoader.classList.remove("hidden");
        compressionLoader.classList.add("flex");
      }
      if (mobileLoader) {
        mobileLoader.classList.remove("hidden");
        mobileLoader.classList.add("flex");
      }

      clearTimeout(timeout);
      timeout = setTimeout(() => {
        compressImage();
      }, 200);
    });

    // Presets
    presetBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        // @ts-ignore
        const qual = btn.dataset.quality;
        if (qualitySlider && qual) {
          qualitySlider.value = qual;
          // Trigger input event to update text and run debounce
          qualitySlider.dispatchEvent(new Event("input"));
        }
      });
    });

    downloadBtn?.addEventListener("click", () => {
      if (!compressedBlob) return;
      const url = URL.createObjectURL(compressedBlob);
      const link = document.createElement("a");
      link.href = url;
      // Determine extension based on actual blob type
      let ext = originalFile?.name.split(".").pop() || "jpg";
      if (compressedBlob.type === "image/webp") ext = "webp";
      else if (compressedBlob.type === "image/jpeg") ext = "jpg";
      else if (compressedBlob.type === "image/png") ext = "png";

      const name = originalFile?.name.replace(/\.[^/.]+$/, "") || "image";
      link.download = `${name}-min.${ext}`;
      link.click();
    });

    // Format Toggle Logic
    function updateFormatUI() {
      if (!formatOriginalBtn || !formatWebPBtn) return;

      const activeClass =
        "bg-amber-100 dark:bg-yellow-400/20 text-amber-700 dark:text-yellow-400 shadow-sm";
      const inactiveClass =
        "text-slate-500 dark:text-slate-500 hover:text-slate-700 dark:hover:text-slate-300";

      if (outputFormat === "original") {
        formatOriginalBtn.className = `px-3 py-1 text-xs font-bold rounded-md transition-all ${activeClass}`;
        formatWebPBtn.className = `px-3 py-1 text-xs font-bold rounded-md transition-all ${inactiveClass}`;
        webpBadge?.classList.add("hidden");
      } else {
        formatWebPBtn.className = `px-3 py-1 text-xs font-bold rounded-md transition-all ${activeClass}`;
        formatOriginalBtn.className = `px-3 py-1 text-xs font-bold rounded-md transition-all ${inactiveClass}`;
        webpBadge?.classList.remove("hidden");
      }
    }

    formatOriginalBtn?.addEventListener("click", () => {
      if (outputFormat === "original") return;
      outputFormat = "original";
      updateFormatUI();
      // Trigger re-compression
      if (compressionLoader) {
        compressionLoader.classList.remove("hidden");
        compressionLoader.classList.add("flex");
      }
      setTimeout(compressImage, 50);
    });

    formatWebPBtn?.addEventListener("click", () => {
      if (outputFormat === "webp") return;
      outputFormat = "webp";
      updateFormatUI();
      // Trigger re-compression
      if (compressionLoader) {
        compressionLoader.classList.remove("hidden");
        compressionLoader.classList.add("flex");
      }
      setTimeout(compressImage, 50);
    });

    // --- Zoom & Pan Logic ---

    function updateTransform() {
      // Apply transform to both images
      const transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoomLevel})`;

      if (previewOriginal) previewOriginal.style.transform = transform;
      if (previewCompressed) previewCompressed.style.transform = transform;
      if (mobilePreview) mobilePreview.style.transform = transform;
    }

    function updateZoomUI() {
      if (zoomValue) zoomValue.textContent = `${Math.round(zoomLevel * 100)}%`;

      // Update Pan Toggle state
      if (panToggle) {
        if (panMode) {
          panToggle.classList.add("text-amber-400", "bg-white/10");
          panToggle.classList.remove("text-slate-300");
          if (desktopContainer)
            (desktopContainer as HTMLElement).style.cursor = "grab";
          if (compareSlider) compareSlider.style.pointerEvents = "none";
        } else {
          panToggle.classList.remove("text-amber-400", "bg-white/10");
          panToggle.classList.add("text-slate-300");
          if (desktopContainer)
            (desktopContainer as HTMLElement).style.cursor = "default";
          if (compareSlider) compareSlider.style.pointerEvents = "auto";
        }
      }
    }

    zoomInBtn?.addEventListener("click", () => {
      if (zoomLevel < 4) {
        zoomLevel = Math.min(4, zoomLevel + 0.5);
        updateTransform();
        updateZoomUI();
      }
    });

    zoomOutBtn?.addEventListener("click", () => {
      if (zoomLevel > 1) {
        zoomLevel = Math.max(1, zoomLevel - 0.5);
        // If resetting to 1, maybe reset pan?
        if (zoomLevel === 1) panOffset = { x: 0, y: 0 };
        updateTransform();
        updateZoomUI();
      }
    });

    panToggle?.addEventListener("click", () => {
      panMode = !panMode;
      updateZoomUI();
    });

    // Toggle Pan with Spacebar
    document.addEventListener("keydown", (e) => {
      if (
        e.code === "Space" &&
        !e.repeat &&
        document.activeElement?.tagName !== "INPUT"
      ) {
        e.preventDefault(); // Prevent scrolling
        panMode = !panMode;
        updateZoomUI();
      }
    });

    // Drag Logic for Pan
    if (desktopContainer) {
      desktopContainer.addEventListener("mousedown", (e) => {
        if (!panMode) return;
        isDragging = true;
        // @ts-ignore
        dragStart = { x: e.clientX - panOffset.x, y: e.clientY - panOffset.y };
        (desktopContainer as HTMLElement).style.cursor = "grabbing";
      });

      window.addEventListener("mousemove", (e) => {
        if (!isDragging || !panMode) return;
        e.preventDefault();
        panOffset = {
          // @ts-ignore
          x: e.clientX - dragStart.x,
          // @ts-ignore
          y: e.clientY - dragStart.y,
        };
        updateTransform();
      });

      window.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          if (panMode && desktopContainer)
            (desktopContainer as HTMLElement).style.cursor = "grab";
        }
      });
    }

    resetBtn?.addEventListener("click", () => {
      originalFile = null;
      compressedBlob = null;
      fileInput.value = "";
      workspace?.classList.add("hidden");
      workspace?.classList.remove("flex");
      workspace?.classList.remove("flex");
      uploadZone?.classList.remove("hidden");
      controlsSection?.classList.add("hidden");
      controlsSection?.classList.remove("flex");
      if (previewOriginal) {
        previewOriginal.src = "";
        previewOriginal.style.transform = "";
      }
      if (previewCompressed) {
        previewCompressed.src = "";
        previewCompressed.style.transform = "";
      }
      if (mobilePreview) mobilePreview.src = "";
      if (mobilePreloadOriginal) mobilePreloadOriginal.src = "";

      // Reset Zoom
      zoomLevel = 1;
      panOffset = { x: 0, y: 0 };
      panMode = false;
      updateZoomUI();
    });
  </script>
</div>
