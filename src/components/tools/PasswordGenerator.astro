---
import { Copy, RefreshCw, Check, Settings2 } from "lucide-react";

interface Props {
  labels?: {
    length: string;
    uppercase: string;
    lowercase: string;
    numbers: string;
    symbols: string;
    copy: string;
    generate: string;
    copied: string;
    strength: string;
  };
}

const {
  labels = {
    length: "Password Length",
    uppercase: "Uppercase (A-Z)",
    lowercase: "Lowercase (a-z)",
    numbers: "Numbers (0-9)",
    symbols: "Symbols (!@#$)",
    copy: "Copy",
    generate: "Generate",
    copied: "Copied!",
    strength: "Strength",
  },
} = Astro.props;
---

<div class="password-generator-wrapper max-w-2xl mx-auto">
  {/* Result Display */}
  <div class="relative mb-8 group">
    <div
      class="absolute inset-0 bg-yellow-400/20 rounded-xl blur-md opacity-0 group-hover:opacity-100 transition-opacity duration-500"
    >
    </div>
    <div class="relative flex items-center">
      <div class="relative w-full">
        <input
          type="text"
          id="password-output"
          readonly
          class="w-full bg-slate-800 text-slate-100 font-mono text-xl md:text-2xl p-5 pr-36 rounded-xl border-2 border-slate-700 focus:border-yellow-400 focus:ring-4 focus:ring-yellow-400/20 outline-none transition-all duration-300 shadow-inner"
          value="Generating..."
        />
        {/* Strength Indicator Line */}
        <div
          class="absolute bottom-0 left-0 h-1 bg-slate-700 w-full rounded-b-xl overflow-hidden"
        >
          <div
            id="strength-bar"
            class="h-full w-0 transition-all duration-500 bg-red-500"
          >
          </div>
        </div>
      </div>

      <div class="absolute right-2 flex gap-2">
        <button
          id="copy-btn"
          class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white transition-colors tooltip-trigger relative overflow-hidden group/btn"
          aria-label={labels.copy}
        >
          <span
            class="absolute inset-0 w-full h-full bg-yellow-400/10 scale-0 group-hover/btn:scale-100 transition-transform rounded-lg"
          ></span>
          <Copy className="w-5 h-5 relative z-10 default-icon" />
          <Check
            className="w-5 h-5 relative z-10 success-icon hidden text-green-400"
          />
        </button>
        <button
          id="refresh-btn"
          class="p-3 rounded-lg bg-yellow-400 hover:bg-yellow-500 text-slate-900 font-bold shadow-lg shadow-yellow-400/20 hover:shadow-yellow-400/40 hover:-translate-y-0.5 transition-all active:scale-95"
          aria-label={labels.generate}
        >
          <RefreshCw className="w-5 h-5" />
        </button>
      </div>
    </div>
  </div>

  {/* Controls Panel */}
  <div
    class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-6 border border-slate-200 dark:border-slate-700/50"
  >
    <div
      class="flex items-center gap-2 mb-6 text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wider"
    >
      <Settings2 className="w-4 h-4" />
      Configuration
    </div>

    {/* Length Slider */}
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <label
          for="length-slider"
          class="font-medium text-slate-700 dark:text-slate-200"
        >
          {labels.length}
        </label>
        <span
          class="bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-yellow-400 font-mono font-bold px-3 py-1 rounded-lg min-w-[3rem] text-center"
          id="length-value">16</span
        >
      </div>
      <input
        type="range"
        id="length-slider"
        min="8"
        max="64"
        value="16"
        class="w-full h-3 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400/50"
      />
    </div>

    {/* Options Grid */}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <label
        class="flex items-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-yellow-400/50 transition-colors group"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            id="opt-uppercase"
            checked
            class="peer sr-only"
          />
          <div
            class="w-5 h-5 border-2 border-slate-400 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 rounded transition-all flex items-center justify-center"
          >
            <Check
              className="w-3.5 h-3.5 text-slate-900 opacity-0 peer-checked:opacity-100"
            />
          </div>
        </div>
        <span
          class="ml-3 font-medium text-slate-700 dark:text-slate-300 group-hover:text-[var(--color-primary)] transition-colors"
          >{labels.uppercase}</span
        >
      </label>

      <label
        class="flex items-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-yellow-400/50 transition-colors group"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            id="opt-lowercase"
            checked
            class="peer sr-only"
          />
          <div
            class="w-5 h-5 border-2 border-slate-400 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 rounded transition-all flex items-center justify-center"
          >
            <Check
              className="w-3.5 h-3.5 text-slate-900 opacity-0 peer-checked:opacity-100"
            />
          </div>
        </div>
        <span
          class="ml-3 font-medium text-slate-700 dark:text-slate-300 group-hover:text-[var(--color-primary)] transition-colors"
          >{labels.lowercase}</span
        >
      </label>

      <label
        class="flex items-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-yellow-400/50 transition-colors group"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            id="opt-numbers"
            checked
            class="peer sr-only"
          />
          <div
            class="w-5 h-5 border-2 border-slate-400 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 rounded transition-all flex items-center justify-center"
          >
            <Check
              className="w-3.5 h-3.5 text-slate-900 opacity-0 peer-checked:opacity-100"
            />
          </div>
        </div>
        <span
          class="ml-3 font-medium text-slate-700 dark:text-slate-300 group-hover:text-[var(--color-primary)] transition-colors"
          >{labels.numbers}</span
        >
      </label>

      <label
        class="flex items-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-yellow-400/50 transition-colors group"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            id="opt-symbols"
            checked
            class="peer sr-only"
          />
          <div
            class="w-5 h-5 border-2 border-slate-400 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 rounded transition-all flex items-center justify-center"
          >
            <Check
              className="w-3.5 h-3.5 text-slate-900 opacity-0 peer-checked:opacity-100"
            />
          </div>
        </div>
        <span
          class="ml-3 font-medium text-slate-700 dark:text-slate-300 group-hover:text-[var(--color-primary)] transition-colors"
          >{labels.symbols}</span
        >
      </label>
    </div>
  </div>
</div>

<script>
  // Core Logic
  const CHARS = {
    uppercase: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
    lowercase: "abcdefghijklmnopqrstuvwxyz",
    numbers: "0123456789",
    symbols: "!@#$%^&*()_+~`|}{[]:;?><,./-=",
  };

  const output = document.getElementById("password-output") as HTMLInputElement;
  const lengthSlider = document.getElementById(
    "length-slider",
  ) as HTMLInputElement;
  const lengthValue = document.getElementById("length-value");
  const checkboxes = {
    uppercase: document.getElementById("opt-uppercase") as HTMLInputElement,
    lowercase: document.getElementById("opt-lowercase") as HTMLInputElement,
    numbers: document.getElementById("opt-numbers") as HTMLInputElement,
    symbols: document.getElementById("opt-symbols") as HTMLInputElement,
  };
  const refreshBtn = document.getElementById("refresh-btn");
  const copyBtn = document.getElementById("copy-btn");
  const strengthBar = document.getElementById("strength-bar");

  function generatePassword() {
    const length = parseInt(lengthSlider.value);
    let chars = "";

    if (checkboxes.uppercase.checked) chars += CHARS.uppercase;
    if (checkboxes.lowercase.checked) chars += CHARS.lowercase;
    if (checkboxes.numbers.checked) chars += CHARS.numbers;
    if (checkboxes.symbols.checked) chars += CHARS.symbols;

    // Fallback if nothing selected
    if (chars === "") {
      checkboxes.lowercase.checked = true;
      chars = CHARS.lowercase;
    }

    let password = "";
    const randomValues = new Uint32Array(length);
    crypto.getRandomValues(randomValues);

    for (let i = 0; i < length; i++) {
      password += chars.charAt(randomValues[i] % chars.length);
    }

    output.value = password;
    calculateStrength(password);
  }

  function calculateStrength(password: string) {
    let score = 0;
    if (password.length > 12) score += 1;
    if (password.length > 20) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^A-Za-z0-9]/.test(password)) score += 1;

    let color = "bg-red-500";
    let width = "20%";

    if (score > 4) {
      color = "bg-green-500";
      width = "100%";
    } else if (score > 3) {
      color = "bg-yellow-400";
      width = "75%";
    } else if (score > 2) {
      color = "bg-orange-400";
      width = "50%";
    }

    if (strengthBar) {
      strengthBar.className = `h-full transition-all duration-500 ${color}`;
      strengthBar.style.width = width;
    }
  }

  function copyToClipboard() {
    output.select();
    navigator.clipboard.writeText(output.value).then(() => {
      const defaultIcon = copyBtn?.querySelector(".default-icon");
      const successIcon = copyBtn?.querySelector(".success-icon");

      defaultIcon?.classList.add("hidden");
      successIcon?.classList.remove("hidden");

      // Visual feedback on button
      copyBtn?.classList.add("bg-green-500/10", "text-green-500");

      setTimeout(() => {
        defaultIcon?.classList.remove("hidden");
        successIcon?.classList.add("hidden");
        copyBtn?.classList.remove("bg-green-500/10", "text-green-500");
      }, 2000);
    });
  }

  // Event Listeners
  if (output) {
    lengthSlider?.addEventListener("input", (e) => {
      if (lengthValue)
        lengthValue.innerText = (e.target as HTMLInputElement).value;
      generatePassword();
    });

    Object.values(checkboxes).forEach((cb) =>
      cb?.addEventListener("change", generatePassword),
    );
    refreshBtn?.addEventListener("click", () => {
      // Add spin animation
      const icon = refreshBtn.querySelector("svg");
      icon?.classList.add("animate-spin");
      setTimeout(() => icon?.classList.remove("animate-spin"), 500);
      generatePassword();
    });
    copyBtn?.addEventListener("click", copyToClipboard);

    // Init
    generatePassword();
  }
</script>
