---
import { languages } from "../i18n/ui";
import { getLangFromUrl } from "../i18n/utils";
import { Globe } from "lucide-react";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

function getPathForLang(l: string) {
    const parts = currentPath.split("/");
    // parts[0] is empty, parts[1] is lang
    // Replace parts[1] with new lang
    const newParts = [...parts];
    if (newParts.length > 1) {
        newParts[1] = l;
    } else {
        // Edge case, root or weird path
        return `/${l}/`;
    }
    return newParts.join("/");
}
---

<div class="relative z-50 language-picker">
    <button
        id="lang-picker-btn"
        class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-colors cursor-pointer"
        aria-label="Change Language"
        aria-expanded="false"
        aria-controls="lang-dropdown"
    >
        <Globe className="w-5 h-5" />
        <span class="uppercase font-medium text-sm">{lang}</span>
    </button>

    <div
        id="lang-dropdown"
        class="absolute right-0 top-full mt-2 w-32 bg-white dark:bg-gray-900 rounded-lg shadow-xl border border-gray-200 dark:border-gray-800 opacity-0 invisible transition-all duration-200 transform origin-top-right scale-95"
    >
        <ul class="py-1">
            {
                Object.entries(languages).map(([key, label]) => (
                    <li>
                        <a
                            href={getPathForLang(key)}
                            class={`block px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 ${key === lang ? "font-bold text-blue-600" : "text-gray-700 dark:text-gray-300"}`}
                        >
                            {label}
                        </a>
                    </li>
                ))
            }
        </ul>
    </div>
</div>

<script>
    const btn = document.getElementById("lang-picker-btn");
    const dropdown = document.getElementById("lang-dropdown");
    const container = document.querySelector(".language-picker");

    if (btn && dropdown && container) {
        btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const isExpanded = btn.getAttribute("aria-expanded") === "true";
            toggleDropdown(!isExpanded);
        });

        // Close when clicking outside
        document.addEventListener("click", (e) => {
            if (!container.contains(e.target as Node)) {
                toggleDropdown(false);
            }
        });

        // Close when pressing Escape
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                toggleDropdown(false);
            }
        });
    }

    function toggleDropdown(show: boolean) {
        if (!btn || !dropdown) return;

        btn.setAttribute("aria-expanded", String(show));

        if (show) {
            dropdown.classList.remove("opacity-0", "invisible", "scale-95");
            dropdown.classList.add("opacity-100", "visible", "scale-100");
        } else {
            dropdown.classList.add("opacity-0", "invisible", "scale-95");
            dropdown.classList.remove("opacity-100", "visible", "scale-100");
        }
    }
</script>
